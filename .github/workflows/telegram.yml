name: Telegram IP Extractor

on:
  schedule:
    # 每天UTC时间3点运行（北京时间11点）
    - cron: '0 3 * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  extract-ips:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install telethon pandas
        
    - name: Check environment variables
      run: |
        echo "=== 环境变量检查 ==="
        if [ -z "${{ secrets.TELEGRAM_API_ID }}" ]; then
          echo "❌ TELEGRAM_API_ID 未设置"
        else
          echo "✅ TELEGRAM_API_ID 已设置"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_API_HASH }}" ]; then
          echo "❌ TELEGRAM_API_HASH 未设置"
        else
          echo "✅ TELEGRAM_API_HASH 已设置"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_PHONE }}" ]; then
          echo "❌ TELEGRAM_PHONE 未设置"
        else
          echo "✅ TELEGRAM_PHONE 已设置"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "❌ TELEGRAM_CHANNEL 未设置"
        else
          echo "✅ TELEGRAM_CHANNEL 已设置: ${{ secrets.TELEGRAM_CHANNEL }}"
        fi
        
    - name: Run Telegram IP Extractor
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      run: |
        echo "=== 开始运行Telegram IP提取器 ==="
        echo "目标频道: $TELEGRAM_CHANNEL"
        python telegram_downloader.py
        
    - name: Check results
      run: |
        echo "=== 运行结果检查 ==="
        echo "当前目录文件:"
        ls -la
        echo ""
        echo "IP文件统计:"
        [ -f "ip.txt" ] && echo "所有IP数量: $(wc -l < ip.txt)" || echo "ip.txt 不存在"
        [ -f "hkip.txt" ] && echo "HK IP数量: $(wc -l < hkip.txt)" || echo "hkip.txt 不存在"
        [ -f "sgip.txt" ] && echo "SG IP数量: $(wc -l < sgip.txt)" || echo "sgip.txt 不存在"
        [ -d "telegram_downloads" ] && echo "CSV文件数量: $(find telegram_downloads -name '*.csv' | wc -l)" || echo "telegram_downloads 目录不存在"
        
    - name: Commit and push results
      run: |
        echo "=== 提交结果 ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 添加所有生成的文件
        git add .
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有更改需要提交"
        else
          echo "提交更改..."
          git commit -m "🤖 Auto-update IP files - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "✅ 提交成功"
        fi
