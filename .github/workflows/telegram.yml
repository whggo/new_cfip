name: Telegram IP Extractor

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´3ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
    - cron: '0 3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  extract-ips:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install telethon pandas
        
    - name: Check environment variables
      run: |
        echo "=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
        if [ -z "${{ secrets.TELEGRAM_API_ID }}" ]; then
          echo "âŒ TELEGRAM_API_ID æœªè®¾ç½®"
        else
          echo "âœ… TELEGRAM_API_ID å·²è®¾ç½®"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_API_HASH }}" ]; then
          echo "âŒ TELEGRAM_API_HASH æœªè®¾ç½®"
        else
          echo "âœ… TELEGRAM_API_HASH å·²è®¾ç½®"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_PHONE }}" ]; then
          echo "âŒ TELEGRAM_PHONE æœªè®¾ç½®"
        else
          echo "âœ… TELEGRAM_PHONE å·²è®¾ç½®"
        fi
        
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "âŒ TELEGRAM_CHANNEL æœªè®¾ç½®"
        else
          echo "âœ… TELEGRAM_CHANNEL å·²è®¾ç½®: ${{ secrets.TELEGRAM_CHANNEL }}"
        fi
        
    - name: Run Telegram IP Extractor
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      run: |
        echo "=== å¼€å§‹è¿è¡ŒTelegram IPæå–å™¨ ==="
        echo "ç›®æ ‡é¢‘é“: $TELEGRAM_CHANNEL"
        python telegram_downloader.py
        
    - name: Check results
      run: |
        echo "=== è¿è¡Œç»“æœæ£€æŸ¥ ==="
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        echo ""
        echo "IPæ–‡ä»¶ç»Ÿè®¡:"
        [ -f "ip.txt" ] && echo "æ‰€æœ‰IPæ•°é‡: $(wc -l < ip.txt)" || echo "ip.txt ä¸å­˜åœ¨"
        [ -f "hkip.txt" ] && echo "HK IPæ•°é‡: $(wc -l < hkip.txt)" || echo "hkip.txt ä¸å­˜åœ¨"
        [ -f "sgip.txt" ] && echo "SG IPæ•°é‡: $(wc -l < sgip.txt)" || echo "sgip.txt ä¸å­˜åœ¨"
        [ -d "telegram_downloads" ] && echo "CSVæ–‡ä»¶æ•°é‡: $(find telegram_downloads -name '*.csv' | wc -l)" || echo "telegram_downloads ç›®å½•ä¸å­˜åœ¨"
        
    - name: Commit and push results
      run: |
        echo "=== æäº¤ç»“æœ ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          echo "æäº¤æ›´æ”¹..."
          git commit -m "ğŸ¤– Auto-update IP files - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æäº¤æˆåŠŸ"
        fi
